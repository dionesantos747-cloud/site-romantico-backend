<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Nosso Amor ğŸ’–</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="only light">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head>
<body class="final">
<div class="preview azul" id="preview">
  <audio id="audioPlayer" controls style="display:none;"></audio>

  <div class="nome" id="nome"></div>
  <div class="mensagem" id="mensagem"></div>
  <div id="midias"></div>
  <div class="dots" id="dots"></div>
  
  <div id="tempo"></div>

  <button id="btnCarta">ğŸ’Œ Abrir carta</button>
  <div class="carta" id="carta"></div>
</div>

<script>
/* =====================
   CARREGAR DADOS DO USUÃRIO
===================== */
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

if (!id) {
  document.body.innerHTML = `
    <div style="text-align:center;color:white;padding:40px">
      <h1>ID invÃ¡lido</h1>
    </div>`;
  throw new Error("ID ausente");
}

fetch(`/user-data?id=${id}`)
  .then(res => res.json())
  .then(data => {

    /* ğŸ”’ SITE NÃƒO ATIVADO */
    if (!data || data.status === "pending") {
      document.body.innerHTML = `
        <div style="text-align:center;color:white;padding:40px">
          <h1>ğŸ’” Site indisponÃ­vel</h1>
          <p>Este site ainda nÃ£o foi ativado.</p>
        </div>`;
      return;
    }

    /* ğŸ”´ SEGURANÃ‡A */
    if (!data.nome) {
      document.body.innerHTML = `
        <div style="text-align:center;color:white;padding:40px">
          <h1>Site nÃ£o encontrado</h1>
        </div>`;
      return;
    }

    /* ===== ELEMENTOS ===== */
    const swipeSound = new Audio("/sounds/card-swipe.mp3");
    const nomeEl = document.getElementById("nome");
    const msgEl = document.getElementById("mensagem");
    const cartaEl = document.getElementById("carta");
    const midiasEl = document.getElementById("midias");
    const audio = document.getElementById("audioPlayer");
    const tempoEl = document.getElementById("tempo");
    const preview = document.getElementById("preview");

    /* ===== TEXTO ===== */
    nomeEl.innerText = data.nome || "";
    msgEl.innerText = data.mensagem || "";
    cartaEl.innerText = data.carta || "";

    /* ===== FUNDO ===== */
    if (data.fundo) {
      preview.className = "preview " + data.fundo;
    }

  /* ===== FOTOS COM EFEITO STACK ===== */
if (Array.isArray(data.fotos) && data.fotos.filter(Boolean).length > 0) {

  function atualizarStack(index) {
    const fotosDOM = document.querySelectorAll("#midias .photo");

    fotosDOM.forEach((foto, i) => {
      foto.classList.remove("active", "behind-1", "behind-2");

      if (i === index) foto.classList.add("active");
      else if (i === index + 1) foto.classList.add("behind-1");
      else if (i === index + 2) foto.classList.add("behind-2");
    });
  }
function ativarSwipe(cartas) {
  cartas.forEach(carta => {
    let startX = 0;
    let currentX = 0;
    let dragging = false;

    carta.addEventListener("pointerdown", e => {
      dragging = true;
      startX = e.clientX;
      carta.setPointerCapture(e.pointerId);
      carta.style.transition = "none";
    });

    carta.addEventListener("pointermove", e => {
      if (!dragging) return;
      currentX = e.clientX - startX;

     carta.style.transform =
  `translateX(calc(-50% + ${currentX}px)) translateY(0) rotate(${currentX / 12}deg) scale(1)`;
    });

    carta.addEventListener("pointerup", () => {
      dragging = false;

      if (Math.abs(currentX) > 120) {
        swipeSound.currentTime = 0;
        swipeSound.play();

        carta.style.transition = "transform 0.4s ease";
        carta.style.transform =
          `translateX(${currentX > 0 ? 150 : -150}vw) rotate(${currentX > 0 ? 25 : -25}deg)`;

        setTimeout(() => {
          carta.remove();
          atualizarStack(0);

          // ğŸ”¥ ativa swipe na prÃ³xima carta
          const ativa = document.querySelector("#midias .photo.active");
          if (ativa) ativarSwipe([ativa]);

        }, 300);
      } else {
        carta.style.transition = "transform 0.3s ease";
        carta.style.transform =
  "translateX(-50%) translateY(0) rotate(0deg) scale(1)";
      }

      currentX = 0;
    });
  });
}
  data.fotos.forEach(url => {
    if (!url) return;

    const div = document.createElement("div");
    div.className = "photo";
    div.innerHTML = `<img src="${url}" style="width:100%">`;
    midiasEl.appendChild(div);
  });

 // ğŸ”¥ ativa o efeito inicial
atualizarStack(0);

// ğŸ”¥ ativa swipe SOMENTE na carta ativa
const ativa = document.querySelector("#midias .photo.active");
if (ativa) ativarSwipe([ativa]);
  
 
} else {
  midiasEl.innerHTML = `
    <p style="opacity:.7;font-style:italic;margin-top:16px">
      ğŸ’– Cada momento aqui Ã© especial
    </p>`;
}

    /* ===== MÃšSICA ===== */
if (data.musica) {
  audio.src = data.musica;
  audio.style.display = "block";
  audio.volume = 0.8; // ğŸ”Š volume inicial
}

    /* ===== CONTADOR ===== */
    if (data.dataInicio) {
      setInterval(() => {
        const inicio = new Date(data.dataInicio);
        const agora = new Date();
        const diff = agora - inicio;
        if (diff < 0) return;

        const s = Math.floor(diff / 1000) % 60;
        const m = Math.floor(diff / 60000) % 60;
        const h = Math.floor(diff / 3600000) % 24;
        const d = Math.floor(diff / 86400000) % 30;
        const mo = Math.floor(diff / 2592000000) % 12;
        const a = Math.floor(diff / 31536000000);

        const anoText = a === 1 ? "ano" : "anos";
        const mesText = mo === 1 ? "mÃªs" : "meses";
        const diaText = d === 1 ? "dia" : "dias";

       tempoEl.innerHTML = `
      <span class="titulo">JÃ¡ estamos juntos hÃ¡</span>
      <div class="contador">
        <div class="item">${a} anos</div>
        <div class="item">${mo} meses</div>
        <div class="item">${d} dias</div>
        <div class="item">${h}h ${m}m ${s}s</div>
      </div>
    `;
  }, 1000);
}
  });

/* =====================
   CARTA
===================== */
const btnCarta = document.getElementById("btnCarta");
const carta = document.getElementById("carta");

btnCarta.onclick = () => {
  carta.style.display = carta.style.display === "block" ? "none" : "block";
  btnCarta.innerText =
    carta.style.display === "block"
      ? "âŒ Fechar carta"
      : "ğŸ’Œ Abrir carta";
};

/* =====================
   CORAÃ‡Ã•ES
===================== */
function criarCoracoes() {
  document.querySelectorAll(".heart").forEach(h => h.remove());
  for (let i = 0; i < 12; i++) {
    const h = document.createElement("div");
    h.className = "heart";
    h.innerText = "â¤ï¸";
    h.style.left = Math.random() * 100 + "%";
    h.style.animationDuration = 6 + Math.random() * 6 + "s";
    document.getElementById("preview").appendChild(h);
  }
}
criarCoracoes();
</script>

</body>
</html>
