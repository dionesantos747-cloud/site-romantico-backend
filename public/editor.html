<script>
document.addEventListener("DOMContentLoaded", () => {

  const LIMITE_MUSICA_MB = 5;

  const nomeInput = document.getElementById("nomeInput");
  const msgInput = document.getElementById("msgInput");
  const cartaInput = document.getElementById("cartaInput");
  const dataInput = document.getElementById("dataInput");

  const nome = document.getElementById("nome");
  const mensagem = document.getElementById("mensagem");
  const carta = document.getElementById("carta");
  const tempo = document.getElementById("tempo");
  const preview = document.getElementById("preview");

  const fotoInput = document.getElementById("fotoInput");
  const midias = document.getElementById("midias");

  const musicBox = document.getElementById("musicBox");
  const musicaInput = document.getElementById("musicaInput");
  const audio = document.getElementById("audioPlayer");
  const removeMusic = document.getElementById("removeMusic");

  const btnCarta = document.getElementById("btnCarta");
  const btnComprar = document.getElementById("btnComprar");

  let fotos = [null, null, null];
  let slotAtual = null;
  let musicaUrl = null;

  /* PREVIEW TEXTO */
  nomeInput.oninput = () => nome.innerText = nomeInput.value;
  msgInput.oninput = () => mensagem.innerText = msgInput.value;
  cartaInput.oninput = () => carta.innerText = cartaInput.value;

  /* CONTADOR */
  setInterval(() => {
    if (!dataInput.value) return;
    const inicio = new Date(dataInput.value);
    const agora = new Date();
    const diff = agora - inicio;
    if (diff < 0) return;

    const s = Math.floor(diff / 1000) % 60;
    const m = Math.floor(diff / 60000) % 60;
    const h = Math.floor(diff / 3600000) % 24;
    const d = Math.floor(diff / 86400000) % 30;
    const mo = Math.floor(diff / 2592000000) % 12;
    const a = Math.floor(diff / 31536000000);

    tempo.innerHTML = `
      <span class="titulo">JÃ¡ estamos juntos hÃ¡</span>
      <div class="contador">
        <div class="item">${a} ${a === 1 ? "ano" : "anos"}</div>
        <div class="item">${mo} ${mo === 1 ? "mÃªs" : "meses"}</div>
        <div class="item">${d} ${d === 1 ? "dia" : "dias"}</div>
        <div class="item">${h}h ${m}m ${s}s</div>
      </div>
    `;
  }, 1000);

  /* CARTA */
  btnCarta.onclick = () => {
    carta.style.display = carta.style.display === "block" ? "none" : "block";
    btnCarta.innerText = carta.style.display === "block"
      ? "âŒ Fechar carta"
      : "ðŸ’Œ Abrir carta";
  };

  /* CORAÃ‡Ã•ES */
  function criarCoracoes() {
    document.querySelectorAll(".heart").forEach(h => h.remove());
    for (let i = 0; i < 12; i++) {
      const h = document.createElement("div");
      h.className = "heart";
      h.innerText = "â¤ï¸";
      h.style.left = Math.random() * 100 + "%";
      h.style.animationDuration = 6 + Math.random() * 6 + "s";
      preview.appendChild(h);
    }
  }
  criarCoracoes();

  /* FUNDOS */
  document.querySelectorAll(".bg-card").forEach(c => {
    c.onclick = () => {
      document.querySelectorAll(".bg-card").forEach(x => x.classList.remove("selected"));
      c.classList.add("selected");
      preview.className = "preview " + c.dataset.bg;
      criarCoracoes();
    };
  });

  /* UPLOADS */
  async function uploadFoto(file) {
    const f = new FormData();
    f.append("file", file);
    const r = await fetch("/upload-image", { method: "POST", body: f });
    return (await r.json()).url;
  }

  async function uploadMusica(file) {
    const f = new FormData();
    f.append("file", file);
    const r = await fetch("/upload-music", { method: "POST", body: f });
    return (await r.json()).url;
  }

  /* FOTOS */
  document.querySelectorAll(".photo-slot").forEach(slot => {
    slot.onclick = () => {
      if (slot.classList.contains("filled")) return;
      slotAtual = slot.dataset.slot;
      fotoInput.click();
    };
  });

  fotoInput.onchange = async e => {
    const file = e.target.files[0];
    if (!file || slotAtual === null) return;

    const cloud = await uploadFoto(file);
    fotos[slotAtual] = cloud;

    const local = URL.createObjectURL(file);
    const div = document.createElement("div");
    div.className = "photo";
    div.innerHTML = `<img src="${local}" style="width:100%">`;

    const remove = document.createElement("div");
    remove.className = "photo-remove";
    remove.innerText = "Ã—";
    remove.onclick = () => {
      fotos[slotAtual] = null;
      div.remove();
    };

    div.appendChild(remove);
    midias.appendChild(div);
    midias.scrollIntoView({ behavior: "smooth" });

    document.querySelector(`.photo-slot[data-slot="${slotAtual}"]`).classList.add("filled");
    slotAtual = null;
    fotoInput.value = "";
  };

  /* MÃšSICA */
  musicBox.onclick = () => musicaInput.click();

  musicaInput.onchange = async () => {
    const file = musicaInput.files[0];
    if (!file) return;

    if (file.size > LIMITE_MUSICA_MB * 1024 * 1024) {
      alert("MÃºsica muito grande (mÃ¡x 2 min)");
      musicaInput.value = "";
      return;
    }

    audio.src = URL.createObjectURL(file);
    audio.style.display = "block";
    audio.play();

    musicaUrl = await uploadMusica(file);

    musicBox.innerText = "ðŸŽ¶ MÃºsica selecionada";
    musicBox.classList.add("disabled");
    removeMusic.style.display = "block";
  };

  removeMusic.onclick = () => {
    audio.src = "";
    audio.style.display = "none";
    musicaInput.value = "";
    musicBox.innerText = "Adicionar mÃºsica ðŸŽµ";
    musicBox.classList.remove("disabled");
    removeMusic.style.display = "none";
  };

  /* PAGAMENTO */
  btnComprar.onclick = async () => {
    if (!nomeInput.value || !msgInput.value || !cartaInput.value || !dataInput.value) {
      alert("Preencha todos os campos");
      return;
    }

    const r = await fetch("/create-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        nome: nomeInput.value,
        mensagem: msgInput.value,
        carta: cartaInput.value,
        dataInicio: dataInput.value,
        fotos,
        musica: musicaUrl
      })
    });

    const d = await r.json();
    sessionStorage.setItem("pix_qr", d.qr_base64);
    sessionStorage.setItem("pix_copia", d.copia_cola);
    location.href = `/aguardando.html?payment_id=${d.payment_id}`;
  };

});
</script>












